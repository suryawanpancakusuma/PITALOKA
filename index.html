<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>Pitaloka ‚Äì Wijaya</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#00796b"/>
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Pitaloka Wijaya&quot;,&quot;short_name&quot;:&quot;Pitaloka&quot;,&quot;start_url&quot;:&quot;./pitaloka-wijaya.html&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#ffffff&quot;,&quot;theme_color&quot;:&quot;#00796b&quot;}">
<link href="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  /* Latar belakang: Pura Ulun Danu Batur, Bali */
  html,body{
    margin:0;padding:0;height:100%;font-family:system-ui,Arial;
    background: url('https://images.unsplash.com/photo-1545251142-f32339076e6d?w=1600&q=85') no-repeat center center fixed;
    background-size: cover;
    color: #fff;
  }
  /* Overlay: gradien halus agar teks kontras */
  body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(135deg,
      rgba(0, 0, 0, 0.4),
      rgba(30, 10, 10, 0.5)
    );
    z-index: -1;
  }

  /* Header indah seperti versi awal */
  .header{
    text-align:center;padding:12px 8px;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
    margin: 8px;
    backdrop-filter: blur(4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .header h1{
    margin:0;font-size:2.3em;font-weight:bold;color:#FFD700;
    text-shadow:2px 2px 8px rgba(0,0,0,0.9);
  }
  .header .sub{
    font-size:1em;color:#FFD700;margin-top:-4px;
    text-shadow:1px 1px 4px rgba(0,0,0,0.7);
  }
  .header .salam,.header .clock{
    margin:2px 0;font-size:1.1em;color:#fff;
    text-shadow:1px 1px 4px rgba(0,0,0,0.7);
  }
  .tabs{display:flex;background:rgba(0,121,107,0.95);color:#fff;}
  .tabs button{
    flex:1;padding:12px;border:none;background:none;font-size:1em;color:#fff;
  }
  .tabs button.active{
    background:#004c40;font-weight:bold;
  }
  .tab-content{display:none;padding:12px;}
  .tab-content.active{display:block;}
  .map-container{height:55vh;border-radius:6px;margin-bottom:8px;overflow:hidden;}
  #map,#mapSearch{height:100%;}
  #coordBox{
    background:rgba(0,0,0,0.7);
    color:#fff;padding:6px;border-radius:4px;
    font-size:.9em;margin-bottom:6px;
  }
  label{
    display:block;margin:6px 0 2px;font-size:.9em;
    color:#fff;
  }
  input,textarea,select{
    width:100%;padding:6px;border-radius:4px;
    border:1px solid #aaa;background:rgba(255,255,255,0.9);
    color:#222;
  }
  button.primary{
    background:#00796b;color:#fff;border:none;
    padding:8px 16px;border-radius:4px;margin-top:6px;
  }
  #poiListWrapper{
    background:rgba(0,0,0,0.75);border-radius:8px;
    padding:10px;color:#fff;
  }
  #poiList{max-height:60vh;overflow:auto;}
  .poiItem{border-bottom:1px solid #444;padding:8px 0;color:#fff;}
  #watermark{
    position:fixed;z-index:999;top:50%;left:50%;
    font-size:2.2em;font-weight:bold;color:#D2B48C;
    text-shadow:2px 2px 8px rgba(0,0,0,0.6);
    opacity:0;pointer-events:none;transform:translate(-50%,-50%) rotate(0deg);
    transition:opacity 0.8s ease-in-out;
    animation: spin 6s linear infinite;
  }
  #watermark.show{
    opacity:0.8;
  }
  @keyframes spin {
    to { transform: translate(-50%,-50%) rotate(360deg); }
  }
  footer{
    text-align:center;padding:8px;font-size:.85em;
    color:#fff;background:rgba(0,0,0,0.5);
  }
  /* Fullscreen Image Viewer */
  .img-modal{display:none;position:fixed;z-index:1000;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);align-items:center;justify-content:center}
  .img-modal img{max-width:90%;max-height:90%}
  /* QR Code Style */
  .qrcode-container {
    display:flex;justify-content:space-between;align-items:center;
    padding:0 10px;flex-wrap:wrap;gap:10px;margin:10px 0;
  }
  .qrcode-item {
    display:flex;flex-direction:column;align-items:center;gap:4px;
  }
  .qrcode-item img {
    width: 80px;height: 80px;border: 1px solid rgba(255,215,0,0.6);
    border-radius: 8px;box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    background: rgba(255,255,255,0.1);
  }
  .qrcode-item p {
    font-size: 0.75rem;margin: 2px 0;color: rgba(255,255,255,0.9);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
  }
  /* Search Hint */
  .search-hint {
    font-size: 0.85em;color: #aaa;margin: 4px 0 8px;text-align: center;
  }
  /* Lihat Data List */
  #listData {
    background: rgba(0,0,0,0.7);
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    max-height: 40vh;
    overflow-y: auto;
    color: #fff;
    font-size: 0.9em;
  }
  #listData h4 {
    color: #FFD700;
    margin-top: 0;
    border-bottom: 1px solid #555;
    padding-bottom: 4px;
  }
  #listData p {
    margin: 6px 0;
    line-height: 1.4;
  }
</style>
</head>
<body>
<!-- Header -->
<div class="header">
  <h1><span style="font-size:1.3em">üå∏</span> PITALOKA <span style="font-size:1.3em">üå∏</span></h1>
  <div class="sub">Pengisian Data Lokasi Usaha</div>
  <div class="salam" id="salam">Selamat datang</div>
  <div class="clock" id="clock">--:--, --.--.----</div>
</div>

<!-- Tabs -->
<div class="tabs">
  <button id="tab1Btn" class="active">Form Lokasi Usaha</button>
  <button id="tab2Btn">POI 500 m</button>
  <button id="tab3Btn">üîç Pencarian Alamat</button>
</div>

<!-- TAB 1 -->
<div id="tab1" class="tab-content active">
  <!-- Map Container -->
  <div class="map-container">
    <div id="map"></div>
  </div>
  <div id="coordBox">Lat: -- , Lng: --</div>
  <form id="formUsaha">
    <label>Nama Usaha / POI<input type="text" id="namaUsaha" required></label>
    <label>Alamat (auto/manual)<textarea id="alamatUsaha" rows="2"></textarea></label>
    <label>Kategori
      <select id="kategoriUsaha">
        <option>Makanan & Minuman</option><option>Pariwisata</option>
        <option>Perdagangan</option><option>Jasa</option><option>Lainnya</option>
      </select>
    </label>
    <label>Jam Buka ‚Äì Tutup<input type="text" id="jamUsaha" placeholder="08:00-22:00"></label>
    <label>Produk/Jasa<textarea id="produkUsaha" rows="2"></textarea></label>
    <label>Segmentasi Konsumen<input type="text" id="segmenUsaha"></label>
    <label>Foto<input type="file" id="fotoUsaha" accept="image/*" multiple capture="environment"></label>
    <div id="fotoPreview" style="margin:6px 0;display:flex;gap:6px;flex-wrap:wrap"></div>
    <label>Nama Pengisi<input type="text" id="namaPengisi" required></label>
    <label>NIP<input type="text" id="nipPengisi"></label>
    <label>Unit Kerja<input type="text" id="unitPengisi"></label>
    <button type="submit" class="primary">üíæ Simpan ke Excel</button>
  </form>
  <button class="primary" onclick="lihatData()">üìÑ Lihat Data</button>
  <button class="primary" onclick="shareData()">üì§ Share File (.xlsx)</button>
  <div id="listData"></div>
</div>

<!-- TAB 2 -->
<div id="tab2" class="tab-content">
  <h3 style="color:#fff;text-shadow:1px 1px 2px #000">üß≠ POI 500 m</h3>
  <div id="poiListWrapper">
    <div id="poiList">Memuat POI...</div>
  </div>
  <button class="primary" onclick="exportExcel()">üì§ Unduh Semua Data</button>
  <button class="primary" onclick="shareData()">üì§ Share File (.xlsx)</button>
</div>

<!-- TAB 3 -->
<div id="tab3" class="tab-content">
  <h3 style="color:#fff;text-shadow:1px 1px 2px #000">üîç Cari Lokasi</h3>
  <!-- Search Hint -->
  <div class="search-hint">Ketik alamat, koordinat, atau klik lokasi di peta</div>
  <!-- Search Input -->
  <input type="text" id="searchInput" placeholder="Nama jalan, desa, pura, atau koordinat..." style="font-size:0.9em;margin-bottom:8px">
  <!-- Map Container -->
  <div class="map-container">
    <div id="mapSearch"></div>
  </div>
  <div id="coordBoxSearch">Lat: -- , Lng: --</div>
  <form id="formSearch">
    <label>Nama Usaha / POI<input type="text" id="namaUsahaSearch" required></label>
    <label>Alamat (auto/manual)<textarea id="alamatUsahaSearch" rows="2"></textarea></label>
    <label>Kategori
      <select id="kategoriUsahaSearch">
        <option>Makanan & Minuman</option><option>Pariwisata</option>
        <option>Perdagangan</option><option>Jasa</option><option>Lainnya</option>
      </select>
    </label>
    <label>Foto<input type="file" id="fotoUsahaSearch" accept="image/*" multiple capture="environment"></label>
    <div id="fotoPreviewSearch" style="margin:6px 0;display:flex;gap:6px;flex-wrap:wrap"></div>
    <label>Nama Pengisi<input type="text" id="namaPengisiSearch" required></label>
    <label>Unit Kerja<input type="text" id="unitPengisiSearch"></label>
    <button type="submit" class="primary">üíæ Simpan ke Excel</button>
  </form>
  <button class="primary" onclick="shareData()">üì§ Share File (.xlsx)</button>
</div>

<div id="watermark">suryawanp@280</div>

<!-- Fullscreen Image Viewer -->
<div class="img-modal" id="imgModal">
  <img id="modalImg" src="" alt="Full Image">
</div>

<!-- QR Code Section -->
<div class="qrcode-container">
  <!-- QR Pitaloka -->
  <div class="qrcode-item">
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=https://suryawanpancakusuma.github.io/PITALOKA/&margin=1&ecc=M" alt="QR Pitaloka">
    <p>Akses Cepat</p>
  </div>
  <!-- QR WhatsApp Support -->
  <div class="qrcode-item">
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=https://wa.me/6281632105566&margin=1&ecc=M" alt="QR WhatsApp">
    <p>Dukungan Teknis</p>
  </div>
</div>

<!-- Footer -->
<footer>
  made with ‚ù§Ô∏è by suryawanp - versi Wijaya
</footer>

<script>
/* ========= Service Worker ========= */
if('serviceWorker' in navigator){
  const swCode = `
self.addEventListener('install',e=>e.waitUntil(
  caches.open('pitaloka-v1').then(c=>c.addAll(['./pitaloka-wijaya.html']))
));
self.addEventListener('fetch',e=>{
  e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
});`;
  const blob = new Blob([swCode],{type:"text/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}

/* ========= IndexedDB ========= */
const DB_NAME="pitalokaFinal", STORE_USAHA="usaha", STORE_POI="poi";
let db;
const openDB = ()=>new Promise((resolve, reject)=>{
  const r = indexedDB.open(DB_NAME,1);
  r.onupgradeneeded = ()=>{
    const d = r.result;
    if(!d.objectStoreNames.contains(STORE_USAHA)) d.createObjectStore(STORE_USAHA,{keyPath:"id",autoIncrement:true});
    if(!d.objectStoreNames.contains(STORE_POI)) d.createObjectStore(STORE_POI,{keyPath:"id",autoIncrement:true});
  };
  r.onsuccess = ()=>{ db = r.result; resolve(); };
  r.onerror = ()=> reject(r.error);
});
(async ()=>{ await openDB(); })();

const add = (store,data)=>new Promise((resolve, reject)=>{
  const tx = db.transaction(store,"readwrite");
  tx.oncomplete = ()=> resolve();
  tx.onerror = ()=> reject(tx.error);
  tx.objectStore(store).add(data);
});

const getAll = store=>new Promise((resolve, reject)=>{
  const tx = db.transaction(store,"readonly");
  const arr=[];
  tx.onerror = ()=> reject(tx.error);
  tx.objectStore(store).openCursor().onsuccess=e=>{
    const c=e.target.result; 
    if(c){arr.push(c.value);c.continue();}else resolve(arr);
  };
});

/* ========= Header clock ========= */
function updateClock(){
  const d=new Date();
  const h=d.getHours();
  const salam = h<11?"Selamat Pagi":h<15?"Selamat Siang":h<19?"Selamat Sore":"Selamat Malam";
  document.getElementById('salam').textContent=salam;
  const hh=d.getHours().toString().padStart(2,'0');
  const mm=d.getMinutes().toString().padStart(2,'0');
  const dd=d.getDate().toString().padStart(2,'0');
  const mo=(d.getMonth()+1).toString().padStart(2,'0');
  const yy=d.getFullYear();
  document.getElementById('clock').textContent=`${hh}:${mm}, ${dd}.${mo}.${yy}`;
}
setInterval(updateClock,1000); updateClock();

/* ========= Tab switcher ========= */
const tabs = document.querySelectorAll('.tab-content');
const btns = document.querySelectorAll('.tabs button');
let map, marker, mapSearch, markerSearch;

function switchTab(idx){
  tabs.forEach(t=>t.classList.remove('active'));
  btns.forEach(b=>b.classList.remove('active'));
  tabs[idx].classList.add('active');
  btns[idx].classList.add('active');

  if(idx === 2 && mapSearch) {
    setTimeout(() => {
      mapSearch.resize();
      if(!markerSearch) getLocation3();
    }, 300);
  }
}
document.getElementById('tab1Btn').onclick = ()=>switchTab(0);
document.getElementById('tab2Btn').onclick = ()=>{ switchTab(1); fetchPOI(); };
document.getElementById('tab3Btn').onclick = ()=>switchTab(2);

/* ========= Map Utama (Satelit, Zoom 18 max) ========= */
window.addEventListener('load', () => {
  requestAnimationFrame(() => {
    map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: { sat: { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 } },
        layers: [{ id: 'sat', type: 'raster', source: 'sat' }]
      },
      center: [118, -2.5],
      zoom: 4.5,
      pitch: 0,
      bearing: 0,
      maxZoom: 18
    });

    map.addControl(new maplibregl.NavigationControl());

    const layerControl = document.createElement('div');
    layerControl.className = 'maplibregl-ctrl';
    layerControl.style.cssText = 'position: absolute; bottom: 10px; left: 10px; display: flex; gap: 4px; z-index: 1000;';
    ['osm', 'sat', 'hybrid'].forEach(mode => {
      const btn = document.createElement('button');
      btn.textContent = mode === 'osm' ? 'OSM' : mode === 'sat' ? 'SAT' : 'HYB';
      btn.title = mode === 'osm' ? 'OpenStreetMap' : mode === 'sat' ? 'Satelit' : 'Hybrid';
      btn.style.cssText = 'width:30px;height:30px;background:white;border:1px solid #ccc;border-radius:4px;font-size:0.7em;font-weight:bold;cursor:pointer;';
      btn.onclick = () => setBase(mode);
      layerControl.appendChild(btn);
    });
    map.on('load', () => {
      map.getContainer().appendChild(layerControl);
    });

    map.on('click', (e) => {
      const { lng, lat } = e.lngLat;
      document.getElementById('coordBox').textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
      if(marker) marker.remove();
      marker = new maplibregl.Marker().setLngLat([lng, lat]).addTo(map);
      document.getElementById('alamatUsaha').value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
    });
    getLocation();
  });
});

/* ========= Layer toggle ========= */
function setBase(mode){
  const styles = {
    osm: {
      version: 8,
      sources: { osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 } },
      layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
    },
    sat: {
      version: 8,
      sources: { sat: { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 } },
      layers: [{ id: 'sat', type: 'raster', source: 'sat' }]
    },
    hybrid: {
      version: 8,
      sources: { 
        sat: { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 },
        osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 }
      },
      layers: [
        { id: 'sat', type: 'raster', source: 'sat' },
        { id: 'osm', type: 'raster', source: 'osm', paint: { 'raster-opacity': 0.6 } }
      ]
    }
  };
  map.setStyle(styles[mode]);
}

/* ========= Geolocation + efek menukik (Superman) ========= */
function getLocation(){
  try{
    const pos = navigator.geolocation.getCurrentPosition(pos => {
      const { longitude, latitude, accuracy } = pos.coords;
      if(accuracy > 10) alert(`Akurasi GPS: ${accuracy.toFixed(1)}m`);
      if(map) map.flyTo({
        center: [longitude, latitude],
        zoom: 18,
        speed: 1.8,
        curve: 1.6,
        easing(t) { return t; },
        essential: true
      });
      if(marker) marker.remove();
      marker = new maplibregl.Marker().setLngLat([longitude, latitude]).addTo(map);
      document.getElementById('coordBox').textContent = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
      document.getElementById('alamatUsaha').value = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
      fetchAddress(latitude, longitude, document.getElementById('alamatUsaha'));
    }, err => {
      console.warn('Gagal dapat lokasi:', err.message);
    }, {enableHighAccuracy:true,timeout:15000});
  }catch(err){
    console.error('Error:', err);
  }
}

// Panggil otomatis saat halaman dimuat
window.addEventListener('load', () => {
  setTimeout(getLocation, 500);
  // Mulai efek watermark
  showWatermark();
  setInterval(showWatermark, 15000);
});

// Efek watermark: muncul 3 detik, lalu hilang
function showWatermark(){
  const wm = document.getElementById('watermark');
  wm.classList.add('show');
  setTimeout(() => wm.classList.remove('show'), 3000);
}

/* ========= Search Address ========= */
async function fetchAddress(lat, lng, inputEl){
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    const data = await res.json();
    inputEl.value = data.display_name || '';
  }catch{ inputEl.value = 'Gagal muat alamat'; }
}

/* ========= Map Pencarian (Zoom 18 max) ========= */
window.addEventListener('load', () => {
  requestAnimationFrame(() => {
    mapSearch = new maplibregl.Map({
      container: 'mapSearch',
      style: {
        version: 8,
        sources: { sat: { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 } },
        layers: [{ id: 'sat', type: 'raster', source: 'sat' }]
      },
      center: [118, -2.5],
      zoom: 4.5,
      pitch: 0,
      bearing: 0,
      maxZoom: 18
    });

    mapSearch.addControl(new maplibregl.NavigationControl());

    const layerControl3 = document.createElement('div');
    layerControl3.className = 'maplibregl-ctrl';
    layerControl3.style.cssText = 'position: absolute; bottom: 10px; left: 10px; display: flex; gap: 4px; z-index: 1000;';
    ['osm', 'sat', 'hybrid'].forEach(mode => {
      const btn = document.createElement('button');
      btn.textContent = mode === 'osm' ? 'OSM' : mode === 'sat' ? 'SAT' : 'HYB';
      btn.title = mode === 'osm' ? 'OpenStreetMap' : mode === 'sat' ? 'Satelit' : 'Hybrid';
      btn.style.cssText = 'width:30px;height:30px;background:white;border:1px solid #ccc;border-radius:4px;font-size:0.7em;font-weight:bold;cursor:pointer;';
      btn.onclick = () => setBase3(mode);
      layerControl3.appendChild(btn);
    });
    mapSearch.on('load', () => {
      mapSearch.getContainer().appendChild(layerControl3);
    });

    mapSearch.on('click', (e) => {
      const { lng, lat } = e.lngLat;
      document.getElementById('coordBoxSearch').textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
      if(markerSearch) markerSearch.remove();
      markerSearch = new maplibregl.Marker().setLngLat([lng, lat]).addTo(mapSearch);
      document.getElementById('alamatUsahaSearch').value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
    });
  });
});

// Layer toggle untuk peta pencarian
function setBase3(mode){
  const styles = {
    osm: {
      version: 8,
      sources: { osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 } },
      layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
    },
    sat: {
      version: 8,
      sources: { sat: { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 } },
      layers: [{ id: 'sat', type: 'raster', source: 'sat' }]
    },
    hybrid: {
      version: 8,
      sources: { 
        sat: { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 },
        osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 }
      },
      layers: [
        { id: 'sat', type: 'raster', source: 'sat' },
        { id: 'osm', type: 'raster', source: 'osm', paint: { 'raster-opacity': 0.6 } }
      ]
    }
  };
  mapSearch.setStyle(styles[mode]);
}

// Geolocation untuk Tab 3
function getLocation3(){
  try{
    const pos = navigator.geolocation.getCurrentPosition(pos => {
      const { longitude, latitude, accuracy } = pos.coords;
      if(accuracy > 10) alert(`Akurasi GPS: ${accuracy.toFixed(1)}m`);
      if(mapSearch) mapSearch.flyTo({
        center: [longitude, latitude],
        zoom: 18,
        speed: 1.8,
        curve: 1.6,
        easing(t) { return t; },
        essential: true
      });
      if(markerSearch) markerSearch.remove();
      markerSearch = new maplibregl.Marker().setLngLat([longitude, latitude]).addTo(mapSearch);
      document.getElementById('coordBoxSearch').textContent = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
      document.getElementById('alamatUsahaSearch').value = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
      fetchAddress(latitude, longitude, document.getElementById('alamatUsahaSearch'));
    }, err => {
      console.warn('Gagal dapat lokasi:', err.message);
    }, {enableHighAccuracy:true,timeout:15000});
  }catch(err){
    console.error('Error:', err);
  }
}

// Search input
document.getElementById('searchInput').addEventListener('keypress', async (e) => {
  if(e.key !== 'Enter') return;
  const q = e.target.value;
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if(data.length > 0){
      const { lat, lon } = data[0];
      if(mapSearch) mapSearch.flyTo({ center: [parseFloat(lon), parseFloat(lat)], zoom: 18 });
      if(markerSearch) markerSearch.remove();
      markerSearch = new maplibregl.Marker().setLngLat([parseFloat(lon), parseFloat(lat)]).addTo(mapSearch);
      document.getElementById('coordBoxSearch').textContent = `Lat: ${lat}, Lng: ${lon}`;
      document.getElementById('alamatUsahaSearch').value = data[0].display_name;
    }else{
      alert('Lokasi tidak ditemukan');
    }
  }catch{ alert('Gagal mencari'); }
});

// Fokus otomatis ke input pencarian saat tab dibuka
function focusSearch(){
  setTimeout(() => {
    document.getElementById('searchInput').focus();
  }, 300);
}

/* ========= Foto Preview & Modal ========= */
['fotoUsaha', 'fotoUsahaSearch'].forEach(id => {
  const input = document.getElementById(id);
  const preview = document.getElementById(id === 'fotoUsaha' ? 'fotoPreview' : 'fotoPreviewSearch');
  input.addEventListener('change', function(e){
    preview.innerHTML = '';
    [...e.target.files].forEach(file => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.width = '80px';
        img.style.height = '80px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '4px';
        img.style.cursor = 'pointer';
        img.onclick = () => {
          document.getElementById('modalImg').src = img.src;
          document.getElementById('imgModal').style.display = 'flex';
        };
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });
});

document.getElementById('imgModal').onclick = () => document.getElementById('imgModal').style.display = 'none';

/* ========= Forms ========= */
document.getElementById('formUsaha').addEventListener('submit',async e=>{
  e.preventDefault();
  const files=document.getElementById('fotoUsaha').files;
  const fotos = await Promise.all([...files].map(f=>fileToBase64(f)));
  try {
    await add(STORE_USAHA,{
      tgl:new Date().toLocaleString('id-ID'),
      namaUsaha:document.getElementById('namaUsaha').value,
      alamat:document.getElementById('alamatUsaha').value,
      kategori:document.getElementById('kategoriUsaha').value,
      jam:document.getElementById('jamUsaha').value,
      produk:document.getElementById('produkUsaha').value,
      segmen:document.getElementById('segmenUsaha').value,
      namaPengisi:document.getElementById('namaPengisi').value,
      nip:document.getElementById('nipPengisi').value,
      unitKerja:document.getElementById('unitPengisi').value,
      lat:marker?marker.getLngLat().lat:0,
      lng:marker?marker.getLngLat().lng:0,
      fotoCount:fotos.length,
      fotos
    });
    alert('Data tersimpan');
    e.target.reset();
    document.getElementById('fotoPreview').innerHTML = '';
  } catch(err) {
    alert('Gagal simpan  ' + err.message);
  }
});

document.getElementById('formSearch').addEventListener('submit',async e=>{
  e.preventDefault();
  const files=document.getElementById('fotoUsahaSearch').files;
  const fotos = await Promise.all([...files].map(f=>fileToBase64(f)));
  try {
    await add(STORE_USAHA,{
      tgl:new Date().toLocaleString('id-ID'),
      namaUsaha:document.getElementById('namaUsahaSearch').value,
      alamat:document.getElementById('alamatUsahaSearch').value,
      kategori:document.getElementById('kategoriUsahaSearch').value,
      jam:document.getElementById('jamUsaha').value,
      produk:document.getElementById('produkUsaha').value,
      segmen:document.getElementById('segmenUsaha').value,
      namaPengisi:document.getElementById('namaPengisiSearch').value,
      unitKerja:document.getElementById('unitPengisiSearch').value,
      lat:markerSearch?markerSearch.getLngLat().lat:0,
      lng:markerSearch?markerSearch.getLngLat().lng:0,
      fotoCount:fotos.length,
      fotos
    });
    alert('Data tersimpan dari pencarian');
    e.target.reset();
    document.getElementById('fotoPreviewSearch').innerHTML = '';
  } catch(err) {
    alert('Gagal simpan  ' + err.message);
  }
});

/* ========= Auto-Save Draft tiap 15 detik ========= */
setInterval(() => {
  const form = document.getElementById('formUsaha');
  const draft = {
    namaUsaha: document.getElementById('namaUsaha').value,
    alamatUsaha: document.getElementById('alamatUsaha').value,
    kategoriUsaha: document.getElementById('kategoriUsaha').value,
    jamUsaha: document.getElementById('jamUsaha').value,
    produkUsaha: document.getElementById('produkUsaha').value,
    segmenUsaha: document.getElementById('segmenUsaha').value,
    namaPengisi: document.getElementById('namaPengisi').value,
    nipPengisi: document.getElementById('nipPengisi').value,
    unitPengisi: document.getElementById('unitPengisi').value
  };
  localStorage.setItem('pitaloka-draft', JSON.stringify(draft));
}, 15000);

// Load draft saat buka
window.addEventListener('load', () => {
  const draft = JSON.parse(localStorage.getItem('pitaloka-draft') || '{}');
  Object.keys(draft).forEach(k => {
    if(document.getElementById(k)) document.getElementById(k).value = draft[k];
  });
});

/* ========= Export / Lihat ========= */
async function lihatData(){
  try {
    await openDB();
    const usaha = await getAll(STORE_USAHA);
    const div=document.getElementById('listData'); div.innerHTML='';
    div.innerHTML=`<h4>Data Usaha (${usaha.length})</h4>`+usaha.map(u=>`<p><strong>${u.namaUsaha}</strong><br>${u.alamat}<br>${u.tgl}</p>`).join('');
  } catch(err) {
    alert('Gagal baca  ' + err.message);
  }
}

/* ========= Export Excel dengan Foto di Sel ========= */
async function exportExcel(){
  try {
    await openDB();
    const usaha = await getAll(STORE_USAHA);
    const wb = XLSX.utils.book_new();
    const ws_data = [];
    
    // Header
    ws_data.push(["No", "Tanggal", "Nama Usaha", "Alamat", "Kategori", "Jam", "Produk", "Segmen", "Pengisi", "NIP", "Unit", "Lat", "Lng", "Foto"]);
    
    // Data + Foto
    usaha.forEach((u, i) => {
      const row = [
        i+1,
        u.tgl,
        u.namaUsaha,
        u.alamat,
        u.kategori,
        u.jam,
        u.produk,
        u.segmen,
        u.namaPengisi,
        u.nip,
        u.unitKerja,
        u.lat,
        u.lng,
        "Foto"
      ];
      ws_data.push(row);
      
      // Tambahkan foto ke worksheet
      if(u.fotos && u.fotos.length > 0) {
        u.fotos.forEach((foto, idx) => {
          const img = {
            name: `Foto_${u.id}_${idx}.png`,
            data: foto.split(',')[1], // base64 tanpa header
            type: 'png'
          };
          const cellRef = XLSX.utils.encode_cell({r: i+1, c: 13});
          wb.Sheets["Usaha"] = XLSX.utils.aoa_to_sheet(ws_data);
          wb.Sheets["Usaha"][cellRef] = { t: 's', v: `Foto ${idx+1}` };
          wb.Sheets["Usaha"].images = wb.Sheets["Usaha"].images || [];
          wb.Sheets["Usaha"].images.push({
            name: img.name,
            data: img.data,
            type: img.type,
            position: {
              type: 'oneCellAnchor',
              from: { col: 13, row: i+1 },
              to: { col: 15, row: i+3 },
              width: 80,
              height: 80
            }
          });
        });
      }
    });
    
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Usaha");
    
    // Tambahkan POI
    const poi = await getAll(STORE_POI);
    const wsPoi = XLSX.utils.json_to_sheet(poi);
    XLSX.utils.book_append_sheet(wb, wsPoi, "POI");
    
    XLSX.writeFile(wb, "Pitaloka_Data.xlsx");
  } catch(err) {
    alert('Gagal ekspor Excel: ' + err.message);
  }
}

/* ========= Share File (.xlsx) ========= */
async function shareData(){
  try {
    await openDB();
    const usaha = await getAll(STORE_USAHA);
    const poi = await getAll(STORE_POI);
    const wb = XLSX.utils.book_new();
    const ws_data = [];
    
    ws_data.push(["No", "Tanggal", "Nama Usaha", "Alamat", "Kategori", "Jam", "Produk", "Segmen", "Pengisi", "NIP", "Unit", "Lat", "Lng", "Foto"]);
    
    usaha.forEach((u, i) => {
      ws_data.push([
        i+1, u.tgl, u.namaUsaha, u.alamat, u.kategori, u.jam, u.produk, u.segmen,
        u.namaPengisi, u.nip, u.unitKerja, u.lat, u.lng, u.fotoCount + " foto"
      ]);
    });
    
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Usaha");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(poi), "POI");
    
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const file = new File([blob], "Pitaloka_Data.xlsx", { type: blob.type });

    if ('share' in navigator) {
      try {
        await navigator.share({
          title: 'Data Pitaloka',
          text: 'Berikut data lokasi usaha dari Pitaloka.',
          files: [file]
        });
      } catch (err) {
        if (err.name !== 'AbortError') {
          fallbackShare(file);
        }
      }
    } else {
      fallbackShare(file);
    }
  } catch(err) {
    alert('Gagal share  ' + err.message);
  }
}

function fallbackShare(file) {
  const url = URL.createObjectURL(file);
  const a = document.createElement('a');
  a.href = url;
  a.download = file.name;
  a.click();
  URL.revokeObjectURL(url);
}

/* ========= POI 500 m ========= */
async function fetchPOI(){
  const coords = marker?marker.getLngLat():map.getCenter();
  const q = `[out:json][timeout:15];
(
  node["amenity"](around:500,${coords.lat},${coords.lng});
  way["amenity"](around:500,${coords.lat},${coords.lng});
  relation["amenity"](around:500,${coords.lat},${coords.lng});
);
out center;`;
  try{
    const res = await fetch('https://overpass-api.de/api/interpreter?data='+encodeURIComponent(q));
    const data = await res.json();
    const list = document.getElementById('poiList'); list.innerHTML='';
    data.elements.forEach(el=>{
      const name = el.tags?.name || 'Tanpa nama';
      const cat = el.tags?.amenity || '-';
      const ll = el.type==='node'?[el.lat,el.lon]:[el.center.lat,el.center.lon];
      const dist = (haversine(coords.lat,coords.lng,ll[0],ll[1])*1000).toFixed(0);
      const div = document.createElement('div');
      div.className='poiItem';
      div.innerHTML=`<h4>${name}</h4><p>Kategori: ${cat} | Jarak: ${dist} m</p>`;
      div.onclick = ()=>add(STORE_POI,{tgl:new Date().toLocaleString('id-ID'),nama:name,kategori:cat,lat:ll[0],lng:ll[1],jarak:dist+' m'});
      list.appendChild(div);
    });
  }catch{ alert('Gagal ambil POI'); }
}
function haversine(lat1,lon1,lat2,lon2){
  const R=6371e3, toRad=deg=>deg*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a))/1000;
}

// Utility
function fileToBase64(f){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = reject;
    r.readAsDataURL(f);
  });
}
</script>
</body>
</html>