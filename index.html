<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pitaloka - Pengisian Data Lokasi Usaha</title>
  <meta name="description" content="Aplikasi lokal untuk pendataan usaha - akurasi tinggi, 100% offline" />

  <!-- Embed Manifest JSON (inline base64) -->
  <link rel="manifest" href="application/json;base64,ewogICJuYW1lIjogIlBpdGFsb2thIiwKICAic2hvcnRfbmFtZSI6ICJQaXRhbG9rYSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAwMDAwMCIsCiAgInRoZW1lX2NvbG9yIjogIiNE MjY5MUUiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2Nkbi1pY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8yNS8yNTY1Ny5wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --bali-orange: #D2691E;
      --bali-yellow: #FFD700;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
    }

    /* üåÖ Background: Pantai Kelingking, Nusa Penida */
    body {
      background: url('https://images.unsplash.com/photo-1596394722345-5f513a8e3f5a?w=1600&q=85') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Overlay transparan agar teks terbaca (lebih terang dari sebelumnya) */
    .overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, 
        rgba(0,0,0,0.5), 
        rgba(30,10,10,0.6)
      );
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 2;
      padding: 12px;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.9);
    }

    h1 {
      font-size: 1.9rem;
      color: var(--bali-yellow);
    }

    /* Subtitle: Pengisian Data Lokasi Usaha */
    .subtitle {
      font-size: 1.1rem;
      color: var(--bali-yellow);
      margin: 5px 0 15px;
      font-weight: normal;
      letter-spacing: 0.5px;
    }

    /* Real-time Date & Time */
    .datetime {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.9);
      margin: 5px 0 10px;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.8);
    }

    /* Greeting */
    .greeting {
      font-size: 1.1rem;
      color: rgba(255,255,255,0.95);
      margin: 5px 0 15px;
      font-style: italic;
      text-shadow: 1px 1px 4px rgba(0,0,0,0.8);
    }

    /* Tombol Lokasi di atas peta */
    .action-row {
      text-align: center;
      margin: 10px 0 15px;
    }

    .btn-location {
      background: #FFD700;
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.1rem;
      box-shadow: 0 4px 15px rgba(255,215,0,0.4);
      transition: all 0.3s ease;
      display: inline-block;
    }

    .btn-location:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255,215,0,0.6);
    }

    /* Peta di bawah judul */
    .map-container {
      height: 300px;
      border-radius: 12px;
      overflow: hidden;
      margin: 15px 0;
      border: 1px solid rgba(255,255,255,0.2);
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: var(--bali-yellow);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.15);
      color: #fff;
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255,255,255,0.1);
    }

    button {
      background: var(--bali-orange);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      font-weight: bold;
    }

    .image-preview {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .image-preview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #4169E1;
    }

    .info-box {
      background: rgba(0,0,0,0.5);
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      font-size: 0.9rem;
    }

    footer {
      text-align: center;
      margin-top: 20px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
    }

    /* üí† Watermark Anti-Jiplak - Kontras Tinggi */
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(360deg);
      font-size: 2.5rem;
      font-weight: bold;
      color: rgba(255, 215, 0, 0.15);
      text-shadow: 
        0 0 5px rgba(0,0,0,0.5),
        0 0 10px rgba(0,0,0,0.3);
      pointer-events: none;
      z-index: 1;
      animation: rotate 12s linear infinite, float 4s ease-in-out infinite;
      background: repeating-linear-gradient(
        45deg, 
        transparent, 
        transparent 10px, 
        rgba(255, 215, 0, 0.05) 10px, 
        rgba(255, 215, 0, 0.05) 20px
      );
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* üîî Toast Notification - Eye Catching */
    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: #FFD700;
      padding: 16px 30px;
      border-radius: 14px;
      font-size: 1rem;
      font-weight: bold;
      box-shadow: 0 6px 20px rgba(0,0,0,0.5);
      z-index: 9999;
      opacity: 0;
      transition: opacity 0.4s ease;
      text-align: center;
      max-width: 90%;
      border: 2px solid #FFD700;
      animation: pulse 1.5s infinite;
    }

    .toast.show {
      opacity: 1;
    }

    /* üìã Modal Lihat Semua Data */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 9998;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
    }

    .modal-content {
      background: rgba(255,255,255,0.95);
      color: #000;
      width: 90%;
      max-width: 600px;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      margin: 20px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .modal-header h3 {
      color: #D2691E;
      margin: 0;
    }

    .close-btn {
      background: #D2691E;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    .data-item {
      padding: 12px;
      margin-bottom: 10px;
      background: #f9f9f9;
      border-radius: 10px;
      border-left: 4px solid #D2691E;
    }

    .data-item p {
      margin: 4px 0;
      font-size: 0.95rem;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.6); }
      70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
    }

    @keyframes rotate { 
      0% { transform: translate(-50%, -50%) rotate(0deg); } 
      100% { transform: translate(-50%, -50%) rotate(360deg); } 
    }
    @keyframes float { 
      0%, 100% { transform: translate(-50%, -50%) translateY(0); } 
      50% { transform: translate(-50%, -50%) translateY(-20px); } 
    }
  </style>
</head>
<body>

  <!-- üí† Watermark Anti-Jiplak -->
  <div class="watermark">suryawanp</div>

  <div class="overlay"></div>

  <!-- üîî Toast Notification (3x muncul) -->
  <div class="toast" id="toast">
    üìç Izinkan akses lokasi untuk akurasi tinggi!
    <br><small>Gunakan tombol di bawah untuk mulai</small>
  </div>

  <div class="container">
    <header>
      <h1>üìç Pitaloka</h1>
      <div class="subtitle">Pengisian Data Lokasi Usaha</div>
      <div class="greeting" id="greeting">Sedang memuat salam...</div>
      <div class="datetime" id="datetime">Sedang memuat waktu...</div>
    </header>

    <!-- üîò TOMBOL LOKASI DI ATAS PETA -->
    <div class="action-row">
      <button id="getLocation" class="btn-location">üìç Dapatkan Lokasi (GPS/EXIF)</button>
    </div>

    <!-- üó∫Ô∏è Peta -->
    <div class="map-container">
      <div id="map"></div>
    </div>

    <div class="info-box">
      <strong>üéØ Cara Pilih Lokasi:</strong>
      <br>‚Ä¢ Klik peta untuk pilih lokasi
      <br>‚Ä¢ Seret pin untuk presisi tinggi
      <br>‚Ä¢ Ambil foto ‚Üí lokasi dari EXIF
    </div>

    <div class="form-group"><label>Nama Usaha</label><input type="text" id="namaUsaha" required /></div>
    <div class="form-group"><label>Pemilik</label><input type="text" id="pemilik" required /></div>
    <div class="form-group"><label>Alamat</label><textarea id="alamat" readonly placeholder="Klik tombol lokasi atau peta"></textarea></div>
    <div class="form-group"><label>Jenis Usaha</label>
      <select id="jenisUsaha">
        <option value="">Pilih...</option>
        <option value="kuliner">Kuliner</option>
        <option value="fashion">Fashion</option>
        <option value="jasa">Jasa</option>
        <option value="retail">Retail</option>
        <option value="kerajinan">Kerajinan</option>
        <option value="lainnya">Lainnya</option>
      </select>
    </div>
    <div class="form-group"><label>Jam Operasional</label><input type="text" id="jamOperasional" placeholder="08:00 - 20:00" /></div>
    <div class="form-group"><label>Produk/Jasa</label><textarea id="produk"></textarea></div>
    <div class="form-group">
      <label>Foto Lokasi (max 5)</label>
      <input type="file" id="fotoInput" accept="image/*" capture="environment" multiple />
      <div class="image-preview" id="imagePreview"></div>
    </div>
    <button id="fetchPOI">üîç Ambil POI Radius 100m</button>
    <button id="saveData">üíæ Simpan Data</button>
    <button id="exportData" disabled>üì§ Ekspor Data Usaha</button>
    <button id="exportPOI" disabled>üì§ Ekspor POI (POIxx.xlsx)</button>
    <button id="viewAllData">üìã Lihat Semua Data</button>

    <div class="info-box">
      <strong>üí° Tips:</strong>
      <br>‚Ä¢ Zoom peta hingga level bangunan
      <br>‚Ä¢ Seret pin untuk akurasi sub-10 meter
      <br>‚Ä¢ Izinkan lokasi saat diminta
    </div>

    <footer>&copy; 2025 Pitaloka | 100% Lokal ‚Ä¢ Oleh suryawanp</footer>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SheetJS untuk Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- EXIF.js untuk baca lokasi dari foto -->
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

  <script>
    // === TAMPILKAN TOAST 3x dengan jeda ===
    function showToast() {
      const toast = document.getElementById('toast');
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(showToast, 3000); // Tampilkan lagi setelah 3 detik
      }, 3000); // Tahan 3 detik
    }

    // Tampilkan toast 3 kali
    setTimeout(showToast, 1000);
    setTimeout(() => document.getElementById('toast').classList.remove('show'), 10000);
    setTimeout(() => document.getElementById('toast').style.display = 'none', 10500);

    // === SALAM SESUAI WAKTU ===
    function updateGreeting() {
      const now = new Date();
      const hour = now.getHours();
      let greeting;
      if (hour < 10) greeting = 'Selamat Pagi üåÖ';
      else if (hour < 15) greeting = 'Selamat Siang ‚òÄÔ∏è';
      else if (hour < 18) greeting = 'Selamat Sore üåá';
      else greeting = 'Selamat Malam üåô';
      document.getElementById('greeting').textContent = `${greeting}, Pengguna Pitaloka`;
    }

    // === TANGGAL & WAKTU REAL-TIME (Format: DD-MM-YYYY, hh:mm) ===
    function updateDateTime() {
      const now = new Date();
      const day = String(now.getDate()).padStart(2, '0');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const dateString = `${day}-${month}-${year}, ${hours}:${minutes}`;
      document.getElementById('datetime').textContent = dateString;
    }

    setInterval(updateDateTime, 1000);

    // === GLOBALS ===
    let map, marker;
    let currentLat = -8.409518, currentLng = 115.188919;
    let imagesData = [];
    let poiData = [];
    let isDataSaved = false;

    // === INIT MAP ===
    function initMap(lat, lng) {
      if (map) map.remove();
      map = L.map('map').setView([lat, lng], 18);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
      marker = L.marker([lat, lng], { draggable: true }).addTo(map);
      marker.on('dragend', onMarkerDrag);
      onMarkerDrag();
      map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        onMarkerDrag();
      });
    }

    function onMarkerDrag() {
      const { lat, lng } = marker.getLatLng();
      currentLat = lat;
      currentLng = lng;
      reverseGeocode(lat, lng);
    }

    // === DAPATKAN LOKASI ===
    document.getElementById('getLocation').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation tidak didukung. Gunakan peta manual.');
        initMap(currentLat, currentLng);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          currentLat = latitude;
          currentLng = longitude;
          initMap(latitude, longitude);
          reverseGeocode(latitude, longitude);
          alert(`‚úÖ Lokasi ditemukan: ${accuracy.toFixed(1)}m`);
        },
        (err) => {
          initMap(currentLat, currentLng);
          let msg = 'GPS gagal: ';
          if (err.code === err.PERMISSION_DENIED) msg += 'Izin ditolak. Gunakan peta manual.';
          else if (err.code === err.POSITION_UNAVAILABLE) msg += 'Lokasi tidak tersedia. Cek GPS.';
          else msg += err.message;
          alert(msg);
        },
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    });

    // === REVERSE GEOCODING ===
    async function reverseGeocode(lat, lng) {
      try {
        const res = await fetch(`https://photon.komoot.io/reverse?lat=${lat}&lon=${lng}&lang=id`);
        const data = await res.json();
        if (data.features && data.features.length > 0) {
          document.getElementById('alamat').value = data.features[0].properties.name || data.features[0].properties.osm_value;
        } else {
          throw new Error('Photon tidak temukan alamat');
        }
      } catch (e) {
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
          const data = await res.json();
          document.getElementById('alamat').value = data.display_name || 'Lokasi tidak dikenal';
        } catch (e) {
          document.getElementById('alamat').value = 'Gagal muat alamat';
        }
      }
    }

    // === AMBIL POI DALAM RADIUS 100m ===
    document.getElementById('fetchPOI').addEventListener('click', async () => {
      if (!currentLat || !currentLng) {
        alert('Dapatkan lokasi dulu!');
        return;
      }
      const query = `[out:json];(node(around:100,${currentLat},${currentLng})[shop];node(around:100,${currentLat},${currentLng})[amenity];);out;`;
      try {
        const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
        const data = await res.json();
        poiData = data.elements.map(p => ({
          'Nama Usaha': p.tags.name || 'Tanpa Nama',
          'Alamat': p.tags.address || 'Alamat tidak tersedia',
          'Latitude': p.lat,
          'Longitude': p.lon,
          'Jenis': p.tags.shop || p.tags.amenity || 'Lainnya',
          'Foto': imagesData.length > 0 ? 'Ya' : 'Tidak'
        }));
        alert(`‚úÖ Ditemukan ${poiData.length} usaha dalam radius 100m`);
      } catch (e) {
        alert('Gagal ambil POI. Cek koneksi internet.');
      }
    });

    // === UPLOAD FOTO ===
    document.getElementById('fotoInput').addEventListener('change', function(e) {
      const files = Array.from(e.target.files).slice(0, 5);
      const preview = document.getElementById('imagePreview');
      preview.innerHTML = ''; imagesData = [];
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = 800; canvas.height = 600;
            canvas.getContext('2d').drawImage(img, 0, 0, 800, 600);
            canvas.toBlob(blob => {
              imagesData.push({ blob, name: file.name });
              const imgEl = document.createElement('img');
              imgEl.src = URL.createObjectURL(blob);
              preview.appendChild(imgEl);
              EXIF.getData(file, function() {
                const lat = EXIF.getTag(this, "GPSLatitude");
                const lng = EXIF.getTag(this, "GPSLongitude");
                if (lat && lng) {
                  const finalLat = convertDMSToDD(lat, EXIF.getTag(this, "GPSLatitudeRef"));
                  const finalLng = convertDMSToDD(lng, EXIF.getTag(this, "GPSLongitudeRef"));
                  if (confirm(`Gunakan lokasi dari foto? ${finalLat.toFixed(6)}, ${finalLng.toFixed(6)}`)) {
                    currentLat = finalLat;
                    currentLng = finalLng;
                    initMap(finalLat, finalLng);
                    reverseGeocode(finalLat, finalLng);
                  }
                }
              });
            }, 'image/jpeg', 0.7);
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      });
    });

    function convertDMSToDD(dms, ref) {
      const d = dms[0].numerator || dms[0];
      const m = dms[1].numerator || dms[1] || 0;
      const s = (dms[2].numerator || dms[2] || 0) / (dms[2].denominator || 1);
      let dd = d + m / 60 + s / 3600;
      if (ref === "S" || ref === "W") dd = -dd;
      return dd;
    }

    // === SIMPAN DATA ===
    document.getElementById('saveData').addEventListener('click', () => {
      const nama = document.getElementById('namaUsaha').value;
      const pemilik = document.getElementById('pemilik').value;
      const alamat = document.getElementById('alamat').value;
      if (!nama || !pemilik || !alamat) {
        alert('Isi semua data wajib!');
        return;
      }
      isDataSaved = true;
      document.getElementById('exportData').disabled = false;
      document.getElementById('exportPOI').disabled = false;
      showSaveToast();

      // Simpan data ke localStorage
      const allData = JSON.parse(localStorage.getItem('pitalokaData') || '[]');
      allData.push({
        nama,
        pemilik,
        alamat,
        jenisUsaha: document.getElementById('jenisUsaha').value,
        jamOperasional: document.getElementById('jamOperasional').value,
        produk: document.getElementById('produk').value,
        latitude: currentLat,
        longitude: currentLng,
        timestamp: new Date().toLocaleString(),
        foto: imagesData.length > 0 ? 'Ya' : 'Tidak'
      });
      localStorage.setItem('pitalokaData', JSON.stringify(allData));
    });

    // === TOAST SUKSES SIMPAN ===
    function showSaveToast() {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,128,0,0.95);
        color: white;
        padding: 16px 30px;
        border-radius: 14px;
        font-size: 1rem;
        font-weight: bold;
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        z-index: 9999;
        animation: fadeIn 0.5s, fadeOut 0.5s 2.5s forwards;
      `;
      toast.textContent = '‚úÖ Data berhasil disimpan! Sekarang Anda bisa ekspor.';
      document.body.appendChild(toast);
      setTimeout(() => document.body.removeChild(toast), 3500);
    }

    // === LIHAT SEMUA DATA ===
    document.getElementById('viewAllData').addEventListener('click', () => {
      const allData = JSON.parse(localStorage.getItem('pitalokaData') || '[]');
      if (allData.length === 0) {
        alert('Belum ada data yang disimpan.');
        return;
      }

      // Buat modal
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>üìã Semua Data Usaha</h3>
            <button class="close-btn">&times;</button>
          </div>
          <div id="dataList">
            ${allData.map((item, i) => `
              <div class="data-item">
                <p><strong>Nama Usaha:</strong> ${item.nama}</p>
                <p><strong>Pemilik:</strong> ${item.pemilik}</p>
                <p><strong>Alamat:</strong> ${item.alamat}</p>
                <p><strong>Lokasi:</strong> ${item.latitude.toFixed(6)}, ${item.longitude.toFixed(6)}</p>
                <p><strong>Waktu:</strong> ${item.timestamp}</p>
                <p><strong>Foto:</strong> ${item.foto}</p>
              </div>
            `).join('')}
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Tutup modal
      modal.querySelector('.close-btn').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
    });

    // === EKSPOR DATA USAHA ===
    document.getElementById('exportData').addEventListener('click', () => {
      if (!isDataSaved) {
        alert('Harap simpan data dulu!');
        return;
      }
      const nama = document.getElementById('namaUsaha').value;
      const pemilik = document.getElementById('pemilik').value;
      const alamat = document.getElementById('alamat').value;
      const wb = XLSX.utils.book_new();
      const formData = {
        'Nama Usaha': nama,
        'Pemilik': pemilik,
        'Alamat': alamat,
        'Jenis Usaha': document.getElementById('jenisUsaha').value,
        'Jam Operasional': document.getElementById('jamOperasional').value,
        'Produk/Jasa': document.getElementById('produk').value,
        'Latitude': currentLat,
        'Longitude': currentLng,
        'Timestamp': new Date().toLocaleString(),
        'Input By': 'suryawanp'
      };
      const ws = XLSX.utils.json_to_sheet([formData]);
      XLSX.utils.book_append_sheet(wb, ws, 'Data Usaha');
      XLSX.writeFile(wb, `data_usaha_${Date.now()}.xlsx`);
    });

    // === EKSPOR POI ===
    document.getElementById('exportPOI').addEventListener('click', () => {
      if (!isDataSaved) {
        alert('Harap simpan data dulu!');
        return;
      }
      if (poiData.length === 0) {
        alert('Ambil POI dulu!');
        return;
      }
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(poiData);
      XLSX.utils.book_append_sheet(wb, ws, 'POI Terdekat');
      const now = new Date();
      const filename = `POI_${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb, filename);
    });

    // === SERVICE WORKER ===
    if ('serviceWorker' in navigator) {
      const swScript = `
        const CACHE_NAME = 'pitaloka-v1';
        const urlsToCache = [
          './',
          'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
          'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
          'https://cdn.jsdelivr.net/npm/exif-js'
        ];
        self.addEventListener('install', e => {
          self.skipWaiting();
          e.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
        });
        self.addEventListener('fetch', e => {
          e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
        });
        self.addEventListener('activate', e => {
          e.waitUntil(caches.keys().then(keys => Promise.all(keys.map(k => k !== CACHE_NAME ? caches.delete(k) : null))));
        });
      `;
      const blob = new Blob([swScript], { type: 'application/javascript' });
      const swURL = URL.createObjectURL(blob);
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(swURL)
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW failed:', err));
      });
    }

    // === INIT ===
    updateGreeting();
    updateDateTime();
    initMap(currentLat, currentLng);
  </script>
</body>
</html>