<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>Pitaloka ‚Äì PWA Final</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#00796b"/>
<link rel="manifest" href="data:application/manifest+json,{
  &quot;name&quot;:&quot;Pitaloka Final&quot;,
  &quot;short_name&quot;:&quot;Pitaloka&quot;,
  &quot;start_url&quot;:&quot;./pitaloka-final.html&quot;,
  &quot;display&quot;:&quot;standalone&quot;,
  &quot;background_color&quot;:&quot;#ffffff&quot;,
  &quot;theme_color&quot;:&quot;#00796b&quot;
}">
<link href="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.css" rel="stylesheet"/>
<script src="https://unpkg.com/maplibre-gl@3/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
html,body{margin:0;padding:0;height:100%;font-family:system-ui,Arial;background:url('https://images.unsplash.com/photo-1537996194471-e657df975ab4?auto=format&fit=crop&w=800&q=60') center/cover fixed;color:#222}
.header{text-align:center;padding:8px 0;background:rgba(0,0,0,0.45)}
.header h1{margin:0;font-size:2.3em;font-weight:bold;color:#FFD700;text-shadow:2px 2px 4px #000}
.header .sub{font-size:1em;color:#FFD700;margin-top:-4px;text-shadow:1px 1px 2px #000}
.header .salam{margin:2px 0;font-size:1.1em;color:#fff;text-shadow:1px 1px 2px #000}
.header .clock{margin:0;font-size:1.3em;color:#fff;font-weight:bold;text-shadow:1px 1px 2px #000}
.tabs{display:flex;background:#00796b;color:#fff}
.tabs button{flex:1;padding:12px;border:none;background:none;font-size:1em;color:#fff}
.tabs button.active{background:#004c40;font-weight:bold}
.tab-content{display:none;padding:12px}
.tab-content.active{display:block}
#map{height:55vh;border-radius:6px;margin-bottom:8px}
#coordBox{background:rgba(0,0,0,0.7);color:#fff;padding:6px;border-radius:4px;font-size:.9em;margin-bottom:6px}
label{display:block;margin:6px 0 2px;font-size:.9em;color:#fff}
input,textarea,select{width:100%;padding:6px;border-radius:4px;border:1px solid #aaa}
button.primary{background:#00796b;color:#fff;border:none;padding:8px 16px;border-radius:4px;margin-top:6px}
#poiListWrapper{background:rgba(0,0,0,0.75);border-radius:8px;padding:10px;color:#fff}
#poiList{max-height:60vh;overflow:auto}
.poiItem{border-bottom:1px solid #444;padding:8px 0;color:#fff}
#toastHover{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.85);color:#FFD700;padding:18px 28px;
  border-radius:10px;font-size:1.2em;font-weight:bold;z-index:99999;
  cursor:pointer;box-shadow:0 0 20px rgba(0,0,0,0.5);transition:opacity .4s;opacity:0;pointer-events:none}
#toastHover.show{opacity:1;pointer-events:auto}
#watermark{
  position:fixed;z-index:999;top:50%;left:50%;
  font-size:2.2em;font-weight:bold;color:rgba(255,255,255,.55);
  animation:spin 6s linear infinite,blink 1.2s infinite;
  pointer-events:none;transform:translate(-50%,-50%);
}
footer{
  text-align:center;
  padding:8px;
  font-size:.85em;
  color:#fff;
  background:rgba(0,0,0,0.5);
}
@keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
@keyframes blink{0%,100%{opacity:.55}50%{opacity:0}}
</style>
</head>
<body>
<!-- Header -->
<div class="header">
  <h1><span style="font-size:1.3em">üå∫</span> PITALOKA <span style="font-size:1.3em">üå∫</span></h1>
  <div class="sub">Pengisian Data Lokasi Usaha</div>
  <div class="salam" id="salam">Selamat datang</div>
  <div class="clock" id="clock">--:--, --.--.----</div>
</div>

<!-- Tabs -->
<div class="tabs">
  <button id="tab1Btn" class="active">Form Lokasi Usaha</button>
  <button id="tab2Btn">POI 500 m</button>
</div>

<!-- TAB 1 -->
<div id="tab1" class="tab-content active">
  <div id="map"></div>
  <div id="coordBox">Lat: -- , Lng: --</div>
  <form id="formUsaha">
    <label>Nama Usaha / POI<input type="text" id="namaUsaha" required></label>
    <label>Alamat (auto/manual)<textarea id="alamatUsaha" rows="2"></textarea></label>
    <label>Kategori
      <select id="kategoriUsaha">
        <option>Makanan & Minuman</option><option>Pariwisata</option>
        <option>Perdagangan</option><option>Jasa</option><option>Lainnya</option>
      </select>
    </label>
    <label>Jam Buka ‚Äì Tutup<input type="text" id="jamUsaha" placeholder="08:00-22:00"></label>
    <label>Produk/Jasa<textarea id="produkUsaha" rows="2"></textarea></label>
    <label>Segmentasi Konsumen<input type="text" id="segmenUsaha"></label>
    <label>Foto<input type="file" id="fotoUsaha" accept="image/*" multiple capture="environment"></label>
    <label>Nama Pengisi<input type="text" id="namaPengisi" required></label>
    <label>NIP<input type="text" id="nipPengisi"></label>
    <label>Unit Kerja<input type="text" id="unitPengisi"></label>
    <button type="submit" class="primary">üíæ Simpan ke Excel</button>
  </form>
  <button class="primary" onclick="lihatData()">üìÑ Lihat Data</button>
  <button class="primary" onclick="exportExcel()">üì§ Unduh Excel</button>
  <div id="listData" style="margin-top:10px;font-size:.85em;color:#fff"></div>
</div>

<!-- TAB 2 -->
<div id="tab2" class="tab-content">
  <h3 style="color:#fff;text-shadow:1px 1px 2px #000">üß≠ POI 500 m</h3>
  <div id="poiListWrapper">
    <div id="poiList">Memuat POI...</div>
  </div>
  <button class="primary" onclick="exportExcel()">üì§ Unduh Semua Data</button>
</div>

<!-- Hover toast GPS -->
<div id="toastHover" onclick="getLocation()">üìå Klik untuk aktifkan GPS presisi</div>
<div id="watermark">suryawanp@280</div>

<!-- Footer -->
<footer>
  ¬© 2025 ‚Äî Dibuat di Bali dengan cinta ‚ù§Ô∏è oleh suryawan pancakusuma
</footer>

<script>
/* ========= Service Worker ========= */
if('serviceWorker' in navigator){
  const swCode = `
self.addEventListener('install',e=>e.waitUntil(
  caches.open('pitaloka-v1').then(c=>c.addAll(['./pitaloka-final.html']))
));
self.addEventListener('fetch',e=>{
  e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));
});`;
  const blob = new Blob([swCode],{type:"text/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}

/* ========= IndexedDB ========= */
const DB_NAME="pitalokaFinal", STORE_USAHA="usaha", STORE_POI="poi";
let db;
const openDB = ()=>new Promise(res=>{
  const r = indexedDB.open(DB_NAME,1);
  r.onupgradeneeded = ()=>{
    const d = r.result;
    d.createObjectStore(STORE_USAHA,{keyPath:"id",autoIncrement:true});
    d.createObjectStore(STORE_POI,{keyPath:"id",autoIncrement:true});
  };
  r.onsuccess = ()=>{ db = r.result; res(); };
});
openDB();
const add = (store,data)=>db.transaction(store,"readwrite").objectStore(store).add(data);
const getAll = store=>new Promise(res=>{
  const tx = db.transaction(store,"readonly");
  const arr=[]; tx.objectStore(store).openCursor().onsuccess=e=>{
    const c=e.target.result; if(c){arr.push(c.value);c.continue();}else res(arr);
  };
});

/* ========= Header clock ========= */
function updateClock(){
  const d=new Date();
  const h=d.getHours();
  const salam = h<11?"Selamat Pagi":h<15?"Selamat Siang":h<19?"Selamat Sore":"Selamat Malam";
  document.getElementById('salam').textContent=salam;
  const hh=d.getHours().toString().padStart(2,'0');
  const mm=d.getMinutes().toString().padStart(2,'0');
  const dd=d.getDate().toString().padStart(2,'0');
  const mo=(d.getMonth()+1).toString().padStart(2,'0');
  const yy=d.getFullYear();
  document.getElementById('clock').textContent=`${hh}:${mm}, ${dd}.${mo}.${yy}`;
}
setInterval(updateClock,1000); updateClock();

/* ========= Tab switcher ========= */
const tabs = document.querySelectorAll('.tab-content');
const btns = document.querySelectorAll('.tabs button');
function switchTab(idx){
  tabs.forEach(t=>t.classList.remove('active'));
  btns.forEach(b=>b.classList.remove('active'));
  tabs[idx].classList.add('active');
  btns[idx].classList.add('active');
}
document.getElementById('tab1Btn').onclick = ()=>switchTab(0);
document.getElementById('tab2Btn').onclick = ()=>{ switchTab(1); fetchPOI(); };

/* ========= Map ========= */
let map, marker;

// Define styles
const layers = {
  osm: {
    version: 8,
    sources: { osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 } },
    layers: [{ id: 'osm', type: 'raster', source: 'osm' }]
  },
  sat: {
    version: 8,
    sources: { sat: { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 } },
    layers: [{ id: 'sat', type: 'raster', source: 'sat' }]
  },
  hybrid: {
    version: 8,
    sources: { 
      sat: { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 },
      osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 }
    },
    layers: [
      { id: 'sat', type: 'raster', source: 'sat' },
      { id: 'osm', type: 'raster', source: 'osm', paint: { 'raster-opacity': 0.6 } }
    ]
  }
};

// Initialize map with OSM
map = new maplibregl.Map({
  container: 'map',
  style: layers.osm,
  center: [115.188919, -8.409518],
  zoom: 18
});

// Add fullscreen control
map.addControl(new maplibregl.FullscreenControl());

// Add custom layer control with small buttons
const layerControl = document.createElement('div');
layerControl.className = 'maplibregl-ctrl';
layerControl.style.cssText = `
  position: absolute;
  bottom: 10px;
  left: 10px;
  display: flex;
  gap: 4px;
  z-index: 1000;
`;

['osm', 'sat', 'hybrid'].forEach(mode => {
  const btn = document.createElement('button');
  btn.textContent = mode === 'osm' ? 'OSM' : mode === 'sat' ? 'SAT' : 'HYB';
  btn.title = mode === 'osm' ? 'OpenStreetMap' : mode === 'sat' ? 'Satelit' : 'Hybrid';
  btn.style.cssText = `
    width: 30px;
    height: 30px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.7em;
    font-weight: bold;
    cursor: pointer;
    text-align: center;
    line-height: 30px;
    padding: 0;
    margin: 0;
  `;
  btn.onclick = () => setBase(mode);
  layerControl.appendChild(btn);
});

// Add control to map container
map.on('load', () => {
  map.getContainer().appendChild(layerControl);
});

// Click on map
map.on('click', (e) => {
  const { lng, lat } = e.lngLat;
  document.getElementById('coordBox').textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
  if(marker) marker.remove();
  marker = new maplibregl.Marker().setLngLat([lng, lat]).addTo(map);
  document.getElementById('alamatUsaha').value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
});

/* ========= Layer toggle ========= */
function setBase(mode){
  map.setStyle(layers[mode]);
}

/* ========= Geolocation + fly-to ========= */
async function getLocation(){
  document.getElementById('toastHover').classList.remove('show');
  try{
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:15000}));
    const { longitude, latitude } = pos.coords;
    map.flyTo({ center: [longitude, latitude], zoom: 18, speed: 1.2 });
    if(marker) marker.remove();
    marker = new maplibregl.Marker().setLngLat([longitude, latitude]).addTo(map);
    document.getElementById('coordBox').textContent = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
    document.getElementById('alamatUsaha').value = `Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`;
  }catch{ alert('Gagal mendapatkan lokasi GPS'); }
}

/* ========= Forms ========= */
document.getElementById('formUsaha').addEventListener('submit',async e=>{
  e.preventDefault();
  const files=document.getElementById('fotoUsaha').files;
  const fotos = await Promise.all([...files].map(f=>fileToBase64(f)));
  await add(STORE_USAHA,{
    tgl:new Date().toLocaleString('id-ID'),
    namaUsaha:document.getElementById('namaUsaha').value,
    alamat:document.getElementById('alamatUsaha').value,
    kategori:document.getElementById('kategoriUsaha').value,
    jam:document.getElementById('jamUsaha').value,
    produk:document.getElementById('produkUsaha').value,
    segmen:document.getElementById('segmenUsaha').value,
    namaPengisi:document.getElementById('namaPengisi').value,
    nip:document.getElementById('nipPengisi').value,
    unitKerja:document.getElementById('unitPengisi').value,
    lat:marker?marker.getLngLat().lat:0,
    lng:marker?marker.getLngLat().lng:0,
    fotoCount:fotos.length,
    fotos
  });
  alert('Data tersimpan');
  e.target.reset();
});

/* ========= Export / Lihat ========= */
async function lihatData(){
  const usaha = await getAll(STORE_USAHA);
  const div=document.getElementById('listData'); div.innerHTML='';
  div.innerHTML=`<h4>Data Usaha (${usaha.length})</h4>`+usaha.map(u=>`<p>${u.namaUsaha} - ${u.alamat}</p>`).join('');
}
async function exportExcel(){
  const usaha = await getAll(STORE_USAHA);
  const poi = await getAll(STORE_POI);
  const wb = XLSX.utils.book_new();
  const wsUsaha = XLSX.utils.json_to_sheet(usaha);
  const wsPoi = XLSX.utils.json_to_sheet(poi);
  XLSX.utils.book_append_sheet(wb,wsUsaha,"Usaha");
  XLSX.utils.book_append_sheet(wb,wsPoi,"POI");
  XLSX.writeFile(wb,"Pitaloka_Data.xlsx");
}
const fileToBase64=f=>new Promise((res,rej)=>{
  const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(f);
});

/* ========= POI 500 m ========= */
async function fetchPOI(){
  const coords = marker?marker.getLngLat():map.getCenter();
  const q = `[out:json][timeout:15];
(
  node["amenity"](around:500,${coords.lat},${coords.lng});
  way["amenity"](around:500,${coords.lat},${coords.lng});
  relation["amenity"](around:500,${coords.lat},${coords.lng});
);
out center;`;
  try{
    const res = await fetch('https://overpass-api.de/api/interpreter?data='+encodeURIComponent(q));
    const data = await res.json();
    const list = document.getElementById('poiList'); list.innerHTML='';
    data.elements.forEach(el=>{
      const name = el.tags?.name || 'Tanpa nama';
      const cat = el.tags?.amenity || '-';
      const ll = el.type==='node'?[el.lat,el.lon]:[el.center.lat,el.center.lon];
      const dist = (haversine(coords.lat,coords.lng,ll[0],ll[1])*1000).toFixed(0);
      const div = document.createElement('div');
      div.className='poiItem';
      div.innerHTML=`<h4>${name}</h4><p>Kategori: ${cat} | Jarak: ${dist} m</p>`;
      div.onclick = ()=>add(STORE_POI,{tgl:new Date().toLocaleString('id-ID'),nama:name,kategori:cat,lat:ll[0],lng:ll[1],jarak:dist+' m'});
      list.appendChild(div);
    });
  }catch{ alert('Gagal ambil POI'); }
}
function haversine(lat1,lon1,lat2,lon2){
  const R=6371e3, toRad=deg=>deg*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a))/1000;
}

/* Tampilkan toastHover saat load */
window.addEventListener('load',()=>document.getElementById('toastHover').classList.add('show'));
</script>
</body>
</html>