<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<title>Pitaloka Dual-Tab | PWA Multi-Layer</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="theme-color" content="#00796b"/>
<link rel="manifest" href="data:application/manifest+json,{
  &quot;name&quot;:&quot;Pitaloka Dual-Tab Multi-Layer&quot;,
  &quot;short_name&quot;:&quot;Pitaloka&quot;,
  &quot;start_url&quot;:&quot;./pitaloka-dual.html&quot;,
  &quot;display&quot;:&quot;standalone&quot;,
  &quot;background_color&quot;:&quot;#ffffff&quot;,
  &quot;theme_color&quot;:&quot;#00796b&quot;
}">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
 html,body{margin:0;padding:0;height:100%;font-family:system-ui,Arial;background:url('https://images.unsplash.com/photo-1537996194471-e657df975ab4?auto=format&fit=crop&w=800&q=60') center/cover fixed;color:#222}
 .tabs{display:flex;background:#00796b;color:#fff}
 .tabs button{flex:1;padding:12px;border:none;background:none;font-size:1em;color:#fff}
 .tabs button.active{background:#004c40;font-weight:bold}
 .tab-content{display:none;padding:12px}
 .tab-content.active{display:block}
 #map1{height:50vh;border:1px solid #00796b;border-radius:6px;margin-bottom:10px}
 label{display:block;margin:6px 0 2px;font-size:.9em}
 input,textarea,select{width:100%;padding:6px;border-radius:4px;border:1px solid #aaa}
 button.primary{background:#00796b;color:#fff;border:none;padding:8px 16px;border-radius:4px;margin-top:6px}
 #layerControl{background:#fff;padding:4px 8px;border-radius:4px;margin-bottom:6px;display:inline-block;font-size:.85em}
 #poiListWrapper{background:rgba(0,0,0,0.75);border-radius:8px;padding:10px;margin-top:8px;color:#fff}
 #poiList{max-height:60vh;overflow:auto}
 .poiItem{border-bottom:1px solid #444;padding:8px 0;color:#fff}
 .poiItem h4{margin:2px 0;color:#fff}
 .poiItem p{margin:2px 0;font-size:.85em;color:#eee}
 #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#323232;color:#fff;padding:12px 18px;border-radius:4px;z-index:9999;opacity:0;transition:opacity .4s;cursor:pointer}
 #toast.show{opacity:1}
 #watermark{
   position:fixed;z-index:999;top:50%;left:50%;
   font-size:2.2em;font-weight:bold;color:rgba(255,255,255,.55);
   animation:spin 6s linear infinite,blink 1.2s infinite;
   pointer-events:none;transform:translate(-50%,-50%);
 }
 @keyframes spin{to{transform:translate(-50%,-50%) rotate(360deg)}}
 @keyframes blink{0%,100%{opacity:.55}50%{opacity:0}}
</style>
</head>
<body>
<div id="watermark">suryawanp</div>

<div class="tabs">
  <button id="tab1Btn" class="active">Form Lokasi Usaha</button>
  <button id="tab2Btn">POI Sekitar (500 m)</button>
</div>

<!-- TAB 1 -->
<div id="tab1" class="tab-content active">
  <h3>üìç Formulir Lokasi Usaha / POI Inti</h3>
  <div id="layerControl">
    <label>Pilih layer peta:
      <select id="baseLayers">
        <option value="osm">OpenStreetMap</option>
        <option value="carto">CartoDB Positron</option>
        <option value="esri">Esri Satellite</option>
      </select>
    </label>
  </div>
  <div id="map1"></div>

  <form id="formUsaha">
    <label>Nama Usaha / POI<input type="text" id="namaUsaha" required></label>
    <label>Alamat Lengkap<textarea id="alamatUsaha" rows="2" readonly></textarea></label>
    <label>Kategori
      <select id="kategoriUsaha">
        <option>Makanan & Minuman</option><option>Pariwisata</option>
        <option>Perdagangan</option><option>Jasa</option><option>Lainnya</option>
      </select>
    </label>
    <label>Jam Buka ‚Äì Tutup<input type="text" id="jamUsaha" placeholder="08:00-22:00"></label>
    <label>Produk/Jasa<textarea id="produkUsaha" rows="2"></textarea></label>
    <label>Segmentasi Konsumen<input type="text" id="segmenUsaha"></label>
    <label>Foto<input type="file" id="fotoUsaha" accept="image/*" multiple capture="environment"></label>
    <label>Nama Pengisi<input type="text" id="namaPengisi" required></label>
    <label>NIP<input type="text" id="nipPengisi"></label>
    <label>Unit Kerja<input type="text" id="unitPengisi"></label>
    <button type="submit" class="primary">üíæ Simpan & Tambahkan ke Excel</button>
  </form>
  <button class="primary" onclick="lihatData()">üìÑ Lihat Data Tersimpan</button>
  <button class="primary" onclick="exportExcel()">üì§ Unduh Semua Data (.xlsx)</button>
  <div id="listData" style="margin-top:10px;font-size:.85em"></div>
</div>

<!-- TAB 2 -->
<div id="tab2" class="tab-content">
  <h3 style="color:#fff;text-shadow:1px 1px 2px #000">üß≠ POI Sekitar (500 m)</h3>
  <div id="poiListWrapper">
    <div id="poiList">Memuat POI...</div>
  </div>
  <button class="primary" onclick="simpanPoiToExcel()">üíæ Simpan POI ke Excel</button>
  <button class="primary" onclick="lihatData()">üìÑ Lihat Data Tersimpan</button>
  <button class="primary" onclick="exportExcel()">üì§ Unduh Semua Data (.xlsx)</button>
</div>

<!-- Toast izin lokasi -->
<div id="toast" onclick="getLocation()">üìå Klik untuk aktifkan GPS & perbolehkan akses lokasi presisi</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ========= Service Worker ========= */
if('serviceWorker' in navigator){
  const swCode = `
self.addEventListener('install',e=>e.waitUntil(
  caches.open('pitaloka-v1').then(c=>c.addAll([
    './pitaloka-dual.html',
    'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
    'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
    'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
  ]))
));
self.addEventListener('fetch',e=>{
  e.respondWith(
    caches.match(e.request).then(r=>r||fetch(e.request))
  );
});`;
  const blob = new Blob([swCode],{type:"text/javascript"});
  navigator.serviceWorker.register(URL.createObjectURL(blob));
}

/* ========= IndexedDB ========= */
const DB_NAME="pitalokaDual", STORE_USAHA="usaha", STORE_POI="poi";
let db;
const openDB = ()=>new Promise(res=>{
  const r = indexedDB.open(DB_NAME,1);
  r.onupgradeneeded = ()=>{
    const d = r.result;
    d.createObjectStore(STORE_USAHA,{keyPath:"id",autoIncrement:true});
    d.createObjectStore(STORE_POI,{keyPath:"id",autoIncrement:true});
  };
  r.onsuccess = ()=>{ db = r.result; res(); };
});
openDB();
const add = (store,data)=>db.transaction(store,"readwrite").objectStore(store).add(data);
const getAll = store=>new Promise(res=>{
  const tx = db.transaction(store,"readonly");
  const arr=[]; tx.objectStore(store).openCursor().onsuccess=e=>{
    const c=e.target.result; if(c){arr.push(c.value);c.continue();}else res(arr);
  };
});

/* ========= Toast ========= */
function toast(msg,clickable=false){
  const t=document.getElementById('toast');
  t.textContent=msg;
  if(clickable){ t.style.cursor='pointer'; t.onclick=getLocation; }
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), clickable?8000:3000);
}

/* ========= Tab switcher ========= */
const tabs = document.querySelectorAll('.tab-content');
const btns = document.querySelectorAll('.tabs button');
function switchTab(idx){
  tabs.forEach(t=>t.classList.remove('active'));
  btns.forEach(b=>b.classList.remove('active'));
  tabs[idx].classList.add('active');
  btns[idx].classList.add('active');
}
document.getElementById('tab1Btn').onclick = ()=>switchTab(0);
document.getElementById('tab2Btn').onclick = ()=>switchTab(1);

/* ========= Multi-layer map ========= */
const map1 = L.map('map1').setView([0,0],16);
const layers = {
  osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'}),
  carto: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'¬© CartoDB'}),
  esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© Esri'})
};
layers.osm.addTo(map1);
document.getElementById('baseLayers').addEventListener('change',e=>{
  map1.eachLayer(l=>{ if(l!==marker) map1.removeLayer(l); });
  layers[e.target.value].addTo(map1);
});

/* ========= Geolocation ========= */
let myLat,myLng,marker;
async function getLocation(){
  const fallbackIP = async ()=>{
    try{
      const ip = await fetch('https://get.geojs.io/v1/ip/geo.json').then(r=>r.json());
      myLat=parseFloat(ip.latitude); myLng=parseFloat(ip.longitude);
      map1.setView([myLat,myLng],16);
      if(marker) map1.removeLayer(marker);
      marker=L.marker([myLat,myLng]).addTo(map1).bindPopup('Lokasi perkiraan').openPopup();
      fetchAddress(myLat,myLng,document.getElementById('alamatUsaha'));
      fetchNearbyPOI(myLat,myLng);
    }catch{ toast('Gagal fallback IP'); }
  };
  try{
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:15000}));
    myLat = pos.coords.latitude; myLng = pos.coords.longitude;
    map1.setView([myLat,myLng],18);
    if(marker) map1.removeLayer(marker);
    marker=L.marker([myLat,myLng]).addTo(map1).bindPopup('Lokasi GPS').openPopup();
    fetchAddress(myLat,myLng,document.getElementById('alamatUsaha'));
    fetchNearbyPOI(myLat,myLng);
  }catch(e){
    toast('GPS gagal ‚Üí fallback IP',false); fallbackIP();
  }
}
toast('üìå Klik untuk aktifkan GPS & perbolehkan akses lokasi presisi',true);

async function fetchAddress(lat,lng,inputEl){
  try{
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    const data = await res.json();
    inputEl.value = data.display_name || '';
  }catch{ inputEl.value='-';}
}

/* ========= POI ========= */
async function fetchNearbyPOI(lat,lng){
  const q = `[out:json][timeout:15];
(
  node["amenity"](around:500,${lat},${lng});
  way["amenity"](around:500,${lat},${lng});
  relation["amenity"](around:500,${lat},${lng});
);
out center;`;
  try{
    const res = await fetch('https://overpass-api.de/api/interpreter?data='+encodeURIComponent(q));
    const data = await res.json();
    const list = document.getElementById('poiList'); list.innerHTML='';
    data.elements.forEach(el=>{
      const name = el.tags?.name || 'Tanpa nama';
      const cat = el.tags?.amenity || '-';
      const ll = el.type==='node'?[el.lat,el.lon]:[el.center.lat,el.center.lon];
      const dist = (haversine(lat,lng,ll[0],ll[1])*1000).toFixed(0);
      const div = document.createElement('div');
      div.className='poiItem';
      div.innerHTML=`
        <h4>${name}</h4>
        <p>Kategori: ${cat} | Jarak: ${dist} m</p>
        <p>Lat: ${ll[0].toFixed(5)}, Lng: ${ll[1].toFixed(5)}</p>
      `;
      div.onclick = ()=>add(STORE_POI,{
        tgl:new Date().toLocaleString('id-ID'),
        nama:name, kategori:cat,
        lat:ll[0], lng:ll[1], jarak:dist+' m'
      });
      list.appendChild(div);
    });
  }catch{
    toast('Gagal ambil POI');
  }
}
function haversine(lat1,lon1,lat2,lon2){
  const R=6371e3, toRad=deg=>deg*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a))/1000;
}

/* ========= Forms ========= */
document.getElementById('formUsaha').addEventListener('submit',async e=>{
  e.preventDefault();
  const files=document.getElementById('fotoUsaha').files;
  const fotos = await Promise.all([...files].map(f=>fileToBase64(f)));
  await add(STORE_USAHA,{
    tgl:new Date().toLocaleString('id-ID'),
    namaUsaha:document.getElementById('namaUsaha').value,
    alamat:document.getElementById('alamatUsaha').value,
    kategori:document.getElementById('kategoriUsaha').value,
    jam:document.getElementById('jamUsaha').value,
    produk:document.getElementById('produkUsaha').value,
    segmen:document.getElementById('segmenUsaha').value,
    namaPengisi:document.getElementById('namaPengisi').value,
    nip:document.getElementById('nipPengisi').value,
    unitKerja:document.getElementById('unitPengisi').value,
    lat:myLat,lng:myLng,
    fotoCount:fotos.length,
    fotos
  });
  toast('Data usaha tersimpan');
  e.target.reset();
});

/* ========= Export / Lihat ========= */
async function lihatData(){
  const [usaha,poi] = await Promise.all([getAll(STORE_USAHA),getAll(STORE_POI)]);
  const div=document.getElementById('listData'); div.innerHTML='';
  div.innerHTML=`<h4>Data Usaha (${usaha.length})</h4>`+usaha.map(u=>`<p>${u.namaUsaha} - ${u.alamat}</p>`).join('')+
                `<h4>Data POI (${poi.length})</h4>`+poi.map(p=>`<p>${p.nama} - ${p.jarak}</p>`).join('');
}
async function exportExcel(){
  const [usaha,poi] = await Promise.all([getAll(STORE_USAHA),getAll(STORE_POI)]);
  const wb = XLSX.utils.book_new();
  const wsUsaha = XLSX.utils.json_to_sheet(usaha);
  const wsPoi   = XLSX.utils.json_to_sheet(poi);
  XLSX.utils.book_append_sheet(wb,wsUsaha,"Usaha");
  XLSX.utils.book_append_sheet(wb,wsPoi,"POI");
  XLSX.writeFile(wb,"Pitaloka_Dual_Data.xlsx");
}
async function simpanPoiToExcel(){
  toast('POI otomatis tersimpan saat Anda klik item di list');
}
const fileToBase64=f=>new Promise((res,rej)=>{
  const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(f);
});
</script>
</body>
</html>